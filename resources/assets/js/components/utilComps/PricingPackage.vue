<template>
  <div class="pricing">

    <div class="header">
        <h4>{{info.title}}</h4>
        
        <p>
        <span class="cost">{{info.cost}}</span>
        {{info.onetime}}
        </p>
    </div>
    

    <div class="yearly">
        <h4 v-if="!info.free">Available scans</h4>

        <p class="text-muted">{{info.yearly}}</p>
    </div>


    <div class="capabilities">
      <h4 v-if="!info.free">Capabilities</h4>
      <ul class="list_capabilities">
        <li v-for ="cap in info.capabilities" :key="cap">
          <i class="fa fa-caret-right"> </i>
          
          <span> {{cap}} </span>

        </li>
      </ul>

    </div>
    
    <!-- show if not subscribed -->
    <b-button v-if="is_visible_sub_btn" id="btn" class="btn btn-info" @click.once="clickedPackage()">
        Get package! 
    </b-button>

    <!-- show if subscribed -->
    <div id="wrapper">

      <b-button v-if="is_visible_unsub_btn" id="btn" class="btn btn-info" @click.once="cancelPackage()">
          Unsubscribe!
      </b-button>

      <b-button v-if="is_visible_unsub_btn" id="btn" class="btn btn-info" @click.once="cancelNowPackage()">
          Cancel now!
      </b-button>

    </div>
</div>
</template>

<script>
import isLoggedIn from "../../mixins/checkIfLoggedIn";

import eventBus from "../../eventBus";
import { SnotifyPosition, SnotifyStyle } from "vue-snotify";
export default {
  mixins: [isLoggedIn],
  data() {
    return {
      is_visible_sub_btn: true,
      is_visible_unsub_btn: false,
      title: this.info.title,
      stripe_plan : this.info.stripe_plan,
      subbed: false
    };
  },
  mounted() {

    //Ovaj blok dodaje mogucnost iskljucenja sub-a
    eventBus.$on("enableUnsub", () => {
      //enable unsub payment gone through
      if (this.subbed) {
        this.is_visible_sub_btn = false;
        this.is_visible_unsub_btn = true;
      }
    });

    //Ovaj blok dodaje plan u user drop
    eventBus.$on("subscribed", title => {
      let package_match = title === this.info.stripe_title;
      if (package_match) {
        this.subbed = true;
        this.is_visible_sub_btn = false;
        this.is_visible_unsub_btn = true;

        let plan = document.querySelector(".subscription");
        let plan_to_write = '';

        //Plan to Pricing mapping 
        if(title === 'Monthly49')
          plan_to_write = "Lite";
        else if (title === 'Monthly149')
          plan_to_write = "Premium"
        else if (title === 'Monthly499')
          plan_to_write = "Pro"


        
        plan.innerHTML = `${plan_to_write}`;


      } else {
        this.is_visible_sub_btn = true;
        this.is_visible_unsub_btn = false;
      }
    });


  },
  methods: {
    clickedPackage() {
      // checking if user is logged in to show the component
      this.checkIfLogged().then(response => {
        let user_logged_in = response !== null ? true : false;

        if (user_logged_in) {
          eventBus.$emit("packageSelected", this.title.toLowerCase());
        } else {
          this.$snotify.warning(
            `Please login or register first!`,
            "Not logged in!",
            {
              position: SnotifyPosition.centerTop,
              backdrop: 0.5
            }
          );
        }
      });
    },
    cancelPackage() {
      axios.get("/cancle").then(response => {
        if (response.status === 200 && this.subbed) {
          this.$snotify.info(`It will end on 8/3/2018`, `Unsubscribed!`, {
            position: SnotifyPosition.centerTop,
            backdrop: 0.5,
            timeout: 5000
          });

          this.$snotify.success(
            `You've canceled your ${this.title} plan`,
            `Unsubscribed!`,
            {
              position: SnotifyPosition.centerTop,
              backdrop: 0.5,
              timeout: 5000
            }
          );

          this.is_visible_unsub_btn = false;
          this.is_visible_sub_btn = true;
        }
      });
    },
    cancelNowPackage() {
      axios.get("/cancelnow").then(response => {
        if (response.status === 200 && this.subbed) {
          this.$snotify.info(`It will end on 8/3/2018`, `Unsubscribed!`, {
            position: SnotifyPosition.centerTop,
            backdrop: 0.5,
            timeout: 5000
          });

          this.$snotify.success(
            `You've canceled your ${this.title} plan instantly`,
            `Unsubscribed!`,
            {
              position: SnotifyPosition.centerTop,
              backdrop: 0.5,
              timeout: 5000
            }
          );

          this.is_visible_unsub_btn = false;
          this.is_visible_sub_btn = true;
        }
      });
    }
  },
  props: {
    info: {
      type: Object
    }
  }
};
</script>

<style scoped>
.capabilities span {
}
.list_capabilities {
  list-style-type: none;
  text-align: center;
  padding-left: 0;
}
.list_capabilities i {
  float: left;
  padding: 2px;
  padding-left: 0.8rem;
  color: #17a2b8;
}

.cost {
  font-weight: bold;
  font-size: 27px;
}

#btn {
  margin-left: 0;
  width: 100%;
}
.pricing {
  height: fit-content;
  width: fit-content;
  padding-left: 0;
  padding-right: 0;
  padding-top: 10px;
  padding-bottom: 20px;
  text-align: center;
  margin-right: 25px;
  box-shadow: 1px 1px 1px 1px #ddd;
}
.pricing h4 {
  padding: 10px 0;
}
.pricing:first-of-type {
  border-top: 3px solid #3b2fda;
}
.pricing:nth-child(2) {
  border-top: 3px solid #c7294c;
}
.pricing:last-of-type {
  border-top: 3px solid #ecfb1f;
}
.header {
  border-bottom: 1px solid rgb(206, 205, 209);
  margin-bottom: 5%;
}
</style>
