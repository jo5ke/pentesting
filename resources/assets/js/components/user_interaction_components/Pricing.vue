<template>
  <div id="pricingContainer" class="row">
        
        <h2 v-if="isVisLoader" class="col-12" style="text-align:center;" >Payment loading...</h2>
        <div v-if="isVisLoader" class="spinner" id="loader">
            <div class="cube1"></div>
            <div class="cube2"></div>
        </div>


          <pricing-package v-if="!isVisLoader" id="first" class="col-lg-3 offset-lg-0 offset-md-2 col-md-8 offset-sm-3  col-sm-6 offset-1 " :info="pricingPackages.info.lite">

          </pricing-package>
          
          <pricing-package v-if="!isVisLoader" class="col-lg-4 offset-lg-0 offset-1 col-md-8 offset-sm-3  col-sm-6 offset-md-2" :info="pricingPackages.info.premium">

          </pricing-package>

          <pricing-package v-if="!isVisLoader" class="col-lg-3 offset-lg-0 offset-1 col-md-8 offset-sm-3  col-sm-6 offset-md-2" :info="pricingPackages.info.pro">

          </pricing-package>
        
  </div>
  


</template>

<script>
import eventBus from "../../eventBus";
import { SnotifyPosition, SnotifyStyle } from "vue-snotify";
import stripePlan from "../../mixins/checkStripePlan";

import PricingPackage from "../utilComps/PricingPackage.vue";
export default {
  destroyed() {
    let cont = document.getElementById("contentContainer");
    cont.className = "row";
  },
  mounted() {
    let cont = document.getElementById("contentContainer");
    cont.className = "";

    //check if already subscribed subscription

    this.checkStripePlan().then(plan => {
      console.log("plan",plan);
      // Monthly49

      eventBus.$emit("subscribed", plan);
    });

    eventBus.$on("packageSelected", packageName => {
      let firstCase = _.startCase(_.toLower(packageName));
      let lower = _.toLower(packageName);

      window.setTimeout(() => {

        let amount = this.pricingPackages.info[lower];
        let cost = amount.cost;
        cost = cost.slice(1);

        amount = cost;
        amount = new Number(amount);
        
        let formObj = {
          name: `${firstCase} package`,
          currency: "USD",

          token: token => {
            this.isVisLoader = true;
            let vm = this;
            axios
              .post("payment", {
                package: lower,
                token: token,
                amount: amount
              })
              .then(resp => {
                let payment_success = resp.data !== "false";
                if (payment_success) {
                  
                  this.isVisLoader = false;
                  vm.$snotify.success(
                      `Payment successful`,
                      "Success!",
                      {
                        position: SnotifyPosition.centerTop,
                        backdrop: 0.5
                      }
                    );

                  eventBus.$emit("subscribed", firstCase);
                  eventBus.$emit("enableUnsub", true);

                  let timer = window.setTimeout(()=>{
                    window.location.reload(true);
                    clearTimeout(timer);
                  },1500)
                }
                else {
                  vm.$snotify.info(
                      `Please try again.`,
                      "Failed!",
                      {
                        position: SnotifyPosition.centerTop,
                        backdrop: 0.5
                      }
                    );
                }
              });
          }
        };

        //glitch forma
        amount *= 100;
        formObj.amount = amount;

        this.$checkout.open(formObj);
      }, 500);
    });
  },
  mixins: [stripePlan],
  data() {
    return {
      isVisLoader : false,
      pricingPackages: {
        info: {
          lite: {
            stripe_title: "Monthly49",
            free: false,
            title: "Lite",
            cost: "$49",
            onetime: "/mo",
            yearly: "500 sites",
            capabilities: [
              "What happened to your father",
              "Have much respect for your father",
              "My father taught me many things "
            ]
          },
          premium: {
            stripe_title: "Monthly149",
            free: false,
            title: "Premium",
            cost: "$150",
            onetime: "/mo",
            yearly: "1500 /week",
            capabilities: [
              "Toy mouse squeak roll",
              "I cry and cry and cry ",
              "Kitty ipsum dolor sit amet",
              "Soon as door open demand",
              "Ask for more so jump"
            ]
          },
          pro: {
            stripe_title: "Monthly499",
            free: false,
            title: "Pro",
            cost: "$499",
            onetime: "/mo",
            yearly: "2500 /daily",
            capabilities: [
              "What happened to your father",
              "Have much respect for your father",
              "My father taught me many things ",
              "Toy mouse squeak roll",
              "I cry and cry and cry ",
              "Kitty ipsum dolor sit amet",
              "Soon as door open demand",
              "Ask for more so jump"
            ]
          }
        }
      }
    };
  },
  components: {
    PricingPackage
  }
};
</script>

<style scoped>

.spinner {
  margin: 100px auto;
  width: 40px;
  height: 40px;
  position: relative;
}

.cube1,
.cube2 {
  background-color: #333;
  width: 15px;
  height: 15px;
  position: absolute;
  top: 0;
  left: 0;

  -webkit-animation: sk-cubemove 1.8s infinite ease-in-out;
  animation: sk-cubemove 1.8s infinite ease-in-out;
}

.cube2 {
  -webkit-animation-delay: -0.9s;
  animation-delay: -0.9s;
}

@-webkit-keyframes sk-cubemove {
  25% {
    -webkit-transform: translateX(42px) rotate(-90deg) scale(0.5);
  }
  50% {
    -webkit-transform: translateX(42px) translateY(42px) rotate(-180deg);
  }
  75% {
    -webkit-transform: translateX(0px) translateY(42px) rotate(-270deg)
      scale(0.5);
  }
  100% {
    -webkit-transform: rotate(-360deg);
  }
}

@keyframes sk-cubemove {
  25% {
    transform: translateX(42px) rotate(-90deg) scale(0.5);
    -webkit-transform: translateX(42px) rotate(-90deg) scale(0.5);
  }
  50% {
    transform: translateX(42px) translateY(42px) rotate(-179deg);
    -webkit-transform: translateX(42px) translateY(42px) rotate(-179deg);
  }
  50.1% {
    transform: translateX(42px) translateY(42px) rotate(-180deg);
    -webkit-transform: translateX(42px) translateY(42px) rotate(-180deg);
  }
  75% {
    transform: translateX(0px) translateY(42px) rotate(-270deg) scale(0.5);
    -webkit-transform: translateX(0px) translateY(42px) rotate(-270deg)
      scale(0.5);
  }
  100% {
    transform: rotate(-360deg);
    -webkit-transform: rotate(-360deg);
  }
}

@media (min-width : 992px) {
  #first{
    margin-left: 6vw;
  }
}

#pricingContainer {
  margin: 0 auto;
  margin-top: 20px;
}
</style>
