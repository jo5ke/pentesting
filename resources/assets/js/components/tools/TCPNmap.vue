<template>
    <div id="contentContainer" class="toolContainer">
      
        <tool-header>
            <h4 slot="title">TCP Port Scan with Nmap</h4>
        </tool-header>

        <div class="input-group input-url text-center" id="inputElem">
            <p class="left_col">Target : </p>
            <input type="text" value="url" 
            placeholder="Hostname,IP or IP range" ref="url" 
            name="ip" 
            :class="{'has-error':errIp}"
            v-validate="{
            required:true,
            regex:/^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))?$|(https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9]\.[^\s]{2,})/}" 
            
            required v-model="url">

            <span v-if="errors.has('ip')" class="incorrect_input fix_error">
                Invalid ip or url!
            </span>
        </div>
  <schedule-scan :validator="this.$validator" :authorized="isAllowedToScanURL" :parent="this">
        </schedule-scan>
        <div  id="portsScan">

            <div>
              <p class="left_col">Ports to scan : </p>
                <tabs>
                    <tab name="Common" >
                        Scan the most common 100 TCP ports.    
                                
                    </tab>
                    
                    <tab name="Range" >
                        <div id="startEndContainer">
                            
                            <div id="firstPart">
                                <p>Start port</p>
                                <input type="number" placeholder="1" min="1" :max="minimum" v-model.number="rangeMin">
                            </div>
                            <div id="secondPart" >
                                <p>End port</p>
                                <input type="number" placeholder="1024" :min="rangeMin" :max="maximum" v-model.number="rangeMax">
                            </div>
                    
                        </div>
                    </tab>

                    <tab name="List" >
                        <div id="contList">

                           <p>List of ports:</p>
                            <input type="text" ref="listOfPorts" @keyup="checkIfPortOk"
                            placeholder="20,80,443" v-model="arrOfPorts" :class="{'has-error':errPort}">

                            <span v-if="errPort" class="incorrect_input fix_error_mod">
                                Insert numbers between 0 and 65535!
                            </span>
                        </div>
 
                    </tab>
                </tabs>
            </div>
        </div>
        

        <!-- OnOff Buttons -->


        <div id="scanOptions">
              <p class="left_col">Scan Options :</p>

             <!-- <p>Detect service version</p> -->

            <div class="btnContainer">
                <b-form-checkbox v-model="detectServiceVersion" ref="allowed">Detect service version</b-form-checkbox>
            </div>



            <div class="btnContainer">
                <b-form-checkbox v-model="detectOperatingSystem" ref="allowed">Detect operating system</b-form-checkbox>
            </div>

            
            
            
            <!-- <p>Do traceroute</p> -->


            <div class="btnContainer">
                <b-form-checkbox v-model="doTraceroute" ref="allowed">Do traceroute</b-form-checkbox>
            </div>
        


            <!-- <p>Don't ping host (-Pn)</p> -->

            <div class="btnContainer">
                <b-form-checkbox v-model="dontPingHost" ref="allowed">Don't ping host (-Pn)</b-form-checkbox>
            </div>
        

            
        </div>

        <!-- on off btns end -->
        <div id="allowed">

            <b-form-checkbox v-model="isAllowedToScanURL" ref="allowed">I am authorized to scan target</b-form-checkbox>

        </div>        

        <p v-if="!isAllowedToScanURL" class="incorrect_input">
            Authorize scan!
        </p>

        <start-scan @click.native="getData()">
            Start Scan!
        </start-scan>

       

        <div v-if="isVisLoader" class="spinner">
            <div class="cube1"></div>
            <div class="cube2"></div>
        </div>
        
        <textarea v-if="isVisible" readonly name="" id="backLog" cols="100" :rows="lines" v-model="currentLog">
           
        </textarea>
        

    </div>
</template>

<script>
//this is mixin used for getting the child route
import extractRoute from "../../mixins/extractRoute";
import ScheduleScan from "../comps_forEach_tool/ScheduleScan.vue";
import canScan from "../../mixins/scansLeft";
import { SnotifyPosition } from "vue-snotify";

import { Tabs, Tab } from "vue-tabs-component";
import ToolHeader from "../comps_forEach_tool/ToolHeader.vue";
import StartScan from "../comps_forEach_tool/StartScan.vue";
import bFormCheckboxGroup from "bootstrap-vue/es/components/form-checkbox/form-checkbox-group";
export default {
  mixins: [extractRoute, canScan],
  components: {
    Tabs,
    Tab,
    StartScan,
    ScheduleScan,
    ToolHeader,
    bFormCheckboxGroup
  },
  computed: {
    maximum() {
      if (this.rangeMax >= 65535) this.rangeMax = 65535;
    },
    minimum() {
      if (this.rangeMin > 65534) this.rangeMin = 65534;
    },
    errIp() {
      return this.errors.has("ip");
    },
    errPort() {
      return !this.isPortListOk;
    }
  },
  data() {
    return {
      //regexs
      urlReg: new RegExp(
        /(https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9]\.[^\s]{2,})/g
      ),

      ipReg: new RegExp(
        /^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))?$/g
      ),

      //data from checkboxes
      detectServiceVersion: true,
      detectOperatingSystem: true,
      doTraceroute: true,
      dontPingHost: true,
      isAllowedToScanURL: false,
      //data from inputs

      stdPorts: true,
      rangePorts: null,
      listPorts: null,

      //util variables
      rangeMin: 0,
      rangeMax: 1,
      arrOfPorts: "443,80",
      isCommonChecked: true,
      isRangeChecked: false,
      isListChecked: false,
      isPortListOk: true,

      cmd: "",

      //other data

      isVisible: false,
      isVisLoader: false,
      url: "",
      currentLog: "",
      error: "",
      lines: null,
      urlGood: true
    };
  },
  methods: {
    checkIfPortOk() {
      let helperBool = true;

      let arrSplit = this.arrOfPorts.split(",");

      if (arrSplit.length === 0) {
        this.isPortListOk = false;
        return;
      }

      arrSplit.forEach((port, index) => {
        let num = new Number(port);

        if (isNaN(num)) {
          helperBool = false;
          return;
        }

        //last elem is ""
        if (index === arrSplit.length - 1) return;

        if (num >= 65535 || num <= 0) helperBool = false;
      });

      this.isPortListOk = helperBool;
    },
    selectedTab() {
      let elem = document.getElementsByClassName(
        "tabs-component-tab is-active"
      );

      let uri = elem[0].childNodes[0].hash;

      //bools for selected tabs
      let common_tab_selected = uri.indexOf("common") !== -1;
      let range_tab_selected = uri.indexOf("range") !== -1;
      let list_tab_selected = uri.indexOf("list") !== -1;

      if (common_tab_selected) {
        this.isCommonChecked = true;
        this.isRangeChecked = false;
        this.isListChecked = false;
        this.isPortListOk = true;
      }

      if (range_tab_selected) {
        this.isCommonChecked = false;
        this.isRangeChecked = true;
        this.isPortListOk = true;
        this.isListChecked = false;
      }

      if (list_tab_selected) {
        this.isCommonChecked = false;
        this.isRangeChecked = false;
        this.isListChecked = true;
      }
    },
    buildCmd() {
      let resultCmd = "nmap -sS ";

      //ranges common list...

      if (this.isCommonChecked) resultCmd += "-F --top-ports 100";

      if (this.isRangeChecked)
        resultCmd += ` -p${this.rangeMin}-${this.rangeMax}`;

      if (this.isListChecked) {
        resultCmd += ` -p${this.arrOfPorts}`;
      }

      //checkbox vals

      if (this.detectServiceVersion) resultCmd += " -sV";

      if (this.detectOperatingSystem) resultCmd += " -O";

      if (this.doTraceroute) resultCmd += " --traceroute";

      if (this.dontPingHost) resultCmd += " -Pn";

      resultCmd += ` ${this.url}`;

      return resultCmd;
    },
    getCmd() {
      return this.buildCmd();
    },
    getData() {
      this.scansLeft().then(num_of_scans => {
        if (num_of_scans === 0) {
          this.$snotify.warning("0 Scans left!", {
            position: SnotifyPosition.centerTop,
            backdrop: 0.5
          });

          return;
        }
        this.$validator.validateAll().then(result => {
          if (result && this.isAllowedToScanURL) {
            console.log("validate proso");
            this.selectedTab();

            if (!this.isPortListOk) return;

            this.cmd = this.buildCmd();

            this.error = "";
            this.isVisLoader = true;
            const vm = this;

            //hide for new scan..
            vm.isVisible = false;

            axios
              .post("/scanning", {
                url: this.url,
                cmd: this.cmd,
                scan: this.route_to_scan_name()
              })
              .then(function(response) {
                vm.lines = response.data.split(/\r\n|\r|\n/).length;
                vm.currentLog = response.data;
                vm.isVisible = true;
                vm.isVisLoader = false;
              })
              .catch(err => {
                console.log(err);
              });
          }
        });
      });
    }
  }
};
</script>

<style scoped>
.toolContainer {
  width: 50% !important;
}

#scanOptions {
  text-align: center;
  margin: 0 auto;
}

.fix_error {
  position: absolute;
  bottom: 0;
  top: 130%;
}
.fix_error_mod {
  margin: 0 auto;
  width: fit-content;
}
.has-error {
  box-shadow: 0 0 5px rgb(255, 0, 0);
  border: 1px solid rgba(255, 0, 0, 1);
}

#firstPart input {
  width: 60px;
}
#secondPart input {
  width: 60px;
}
#allowed {
  width: fit-content;
  margin: 0 auto;
}

/* toggle btn css */

.tgl-btn {
  float: left;
}

/* toggle btn css */

#portsScan {
  margin-bottom: 5%;
  margin: 20px auto;
}
.tabs-component{
  width:77%!important;
}
#startEndContainer {
  width: 60%;
  margin: 0 auto;
  display: flex;
  flex-direction: row;
}
@media (max-width:992px) {
  #startEndContainer{
    width:100% !important;
  }
}
#contList {
  margin: auto;
  display: flex;
  flex-direction: column;
}

#firstPart {
  flex: 2;
}
#contList input {
  width: 50%;
  margin: 0 auto;
}

#contList p {
  padding-right: 1rem;
}


#firstPart p {
  margin-bottom: 0px;
  text-align: left;
}
#secondPart p {
  text-align: left;
  margin-bottom: 0px;
}

.left_col {
  font-size: 15px;
  font-weight: 500;
  padding-right: 0.5rem;
  margin: auto;
}
#inputElem {
  display: flex;
  line-height: 0.8;
}
#inputElem p {
  flex: 1;
  font-size: 15px;
  font-weight: 500;
  padding-right: 0.5rem;
  margin: auto;
}

.btnGrp {
  height: 20px;
  width: 14rem;
  margin: auto;
  margin-bottom: 20px;
}

#error {
  padding: 2%;
  font-weight: bold;
  color: red;
}

#header p {
  vertical-align: top;
  line-height: 1;
  font-size: 15px;
}
#header i {
  color: chartreuse;
}

textarea {
  resize: none;
  margin: 0 auto;
}
textarea:focus {
  outline: none;
}

.spinner {
  margin: 100px auto;
  width: 40px;
  height: 40px;
  position: relative;
}

.cube1,
.cube2 {
  background-color: #333;
  width: 15px;
  height: 15px;
  position: absolute;
  top: 0;
  left: 0;

  -webkit-animation: sk-cubemove 1.8s infinite ease-in-out;
  animation: sk-cubemove 1.8s infinite ease-in-out;
}

.cube2 {
  -webkit-animation-delay: -0.9s;
  animation-delay: -0.9s;
}

@-webkit-keyframes sk-cubemove {
  25% {
    -webkit-transform: translateX(42px) rotate(-90deg) scale(0.5);
  }
  50% {
    -webkit-transform: translateX(42px) translateY(42px) rotate(-180deg);
  }
  75% {
    -webkit-transform: translateX(0px) translateY(42px) rotate(-270deg)
      scale(0.5);
  }
  100% {
    -webkit-transform: rotate(-360deg);
  }
}

@keyframes sk-cubemove {
  25% {
    transform: translateX(42px) rotate(-90deg) scale(0.5);
    -webkit-transform: translateX(42px) rotate(-90deg) scale(0.5);
  }
  50% {
    transform: translateX(42px) translateY(42px) rotate(-179deg);
    -webkit-transform: translateX(42px) translateY(42px) rotate(-179deg);
  }
  50.1% {
    transform: translateX(42px) translateY(42px) rotate(-180deg);
    -webkit-transform: translateX(42px) translateY(42px) rotate(-180deg);
  }
  75% {
    transform: translateX(0px) translateY(42px) rotate(-270deg) scale(0.5);
    -webkit-transform: translateX(0px) translateY(42px) rotate(-270deg)
      scale(0.5);
  }
  100% {
    transform: rotate(-360deg);
    -webkit-transform: rotate(-360deg);
  }
}

h4 {
  text-align: center;
}
p {
  text-align: center;
}

#header {
  margin: auto;
  border-bottom: 1px solid rgba(0, 0, 0, 0.125);
}
.input-group {
  width: fit-content;
  margin: 20px auto;
}
</style>
