<template>
    <div id="contentContainer">
      
        <tool-header>
            <h4 slot="title">TLS Robot Attack Scanner</h4>
        </tool-header>

        <div class="input-group input-url text-center" id="inputElem">
            <p>Target domain name : </p>
            <input type="text" v-validate="{required:true,regex:/https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9]\.[^\s]{2,}/}"  value="url" name="url"
            :class="{'has-error':errURL}"  placeholder="www.google.com" ref="url" required v-model="url">
            
            <span v-if="errors.has('url')" class="incorrect_input fix_error">
                Invalid url!
            </span>
        </div>


           <schedule-scan :validator="this.$validator" :authorized="isAllowedToScanURL" :parent="this">
        </schedule-scan>

        <div id="scanOptions" >
            <p>Target Service :</p>
            <section id="targetServices" >


                <div class="btnContainer">
                    <input type="checkbox" name="native" id="revDns" class="tgl tgl-ios" v-model="https">
                    <label for="revDns" class="tgl-btn"></label>
                    <p> HTTPS - port 443</p>
                </div>



                <div class="btnContainer">
                    <input type="checkbox" name="native" id="detOpSys" class="tgl tgl-ios" v-model="smtps">
                    <label for="detOpSys" class="tgl-btn"></label>
                    <p> SMTPS - ports 25,2525,587,465</p>
                </div>

            


                <div class="btnContainer">
                    <input type="checkbox" name="native" id="doTrcrt" class="tgl tgl-ios" v-model="imaps">
                    <label for="doTrcrt" class="tgl-btn"></label>
                    <p> IMAPS - ports 143,993</p>
                </div>
                
                


                <div class="btnContainer">
                    <input type="checkbox" name="native" id="dontPingHost" class="tgl tgl-ios" v-model="pop3s">
                    <label for="dontPingHost" class="tgl-btn"></label>
                    <p> POP3S - ports 110,995</p>
                </div>

                <div class="btnContainer">
                    <input type="checkbox" name="native" id="ftps" class="tgl tgl-ios" v-model="ftps">
                    <label for="ftps" class="tgl-btn"></label>
                    <p> FTPS - ports 21</p>
                </div>
            

            </section>
        </div>

        <div id="allowed">
            <b-form-checkbox v-model="isAllowedToScanURL" 
            ref="allowed">I am authorized to scan this target</b-form-checkbox>
        </div> 
        
        <p v-if="!isAllowedToScanURL" class="incorrect_input">
            Authorize scan!
        </p>
  
        <start-scan @click.native="getData()">
            Start Scan!
        </start-scan>

        
        <div v-if="isVisLoader" class="spinner">
            <div class="cube1"></div>
            <div class="cube2"></div>
        </div>
        
        <textarea v-if="isVisible" readonly name="" id="backLog" cols="100" :rows="lines" v-model="currentLog">
           
        </textarea>
      

    </div>
</template>

<script>
//this is mixin used for getting the child route
import extractRoute from "../../mixins/extractRoute";
import ScheduleScan from "../comps_forEach_tool/ScheduleScan.vue";

import ToolHeader from "../comps_forEach_tool/ToolHeader.vue";
import StartScan from "../comps_forEach_tool/StartScan.vue";
export default {
  mixins: [extractRoute],
  components: {
    StartScan,
    ScheduleScan,
    ToolHeader
  },
  computed: {
    errURL() {
      return this.errors.has("url");
    }
  },
  data() {
    return {
      cmd: "",

      //data
      https: true,
      smtps: true,
      imaps: true,
      pop3s: true,
      ftps: true,

      url: "",

      isAllowedToScanURL: false,
      isVisible: false,
      isVisLoader: false,
      currentLog: "",
      lines: null
    };
  },
  methods: {
    //
    getCmd() {
      let cmdR = `nmap -sV  --script ssl-poodle --script-args=vulns.showall `;
      cmdR += `-p`;

      if (this.https) cmdR += "443";
      if (this.smtps) cmdR += ",25,2525,587,465";
      if (this.imaps) cmdR += ",143,993";
      if (this.pop3s) cmdR += ",110,995";
      if (this.ftps) cmdR += ",21";

      cmdR += " ";

      cmdR += this.url;
      return cmdR;
    },

    getData() {
      this.cmd = `nmap -sV  --script ssl-poodle --script-args=vulns.showall `;
      this.cmd += `-p`;

      if (this.https) this.cmd += "443";
      if (this.smtps) this.cmd += ",25,2525,587,465";
      if (this.imaps) this.cmd += ",143,993";
      if (this.pop3s) this.cmd += ",110,995";
      if (this.ftps) this.cmd += ",21";

      this.cmd += " ";

      this.cmd += this.url;

      this.$validator.validateAll().then(result => {
        if (result && this.isAllowedToScanURL) {
          this.isVisLoader = true;
          const vm = this;
          //hide for new scan..
          vm.isVisible = false;

          axios
            .post("/scanning", {
              url: this.url,
              cmd: this.cmd,
              scan: this.route_to_scan_name()
            })
            .then(function(response) {
              vm.lines = response.data.split(/\r\n|\r|\n/).length;

              vm.currentLog = response.data;
              vm.isVisible = true;
              vm.isVisLoader = false;
            })
            .catch(function(error) {});
        } else {
          this.isVisLoader = false;
        }
      });
    }
  }
};
</script>

<style scoped>
#targetServices {
  width: fit-content;
  margin: 0 auto;
}
#scanOptions > p {
  font-size: 15px;
  font-weight: 500;
  padding-right: 0.5rem;
}

.fix_error {
  position: absolute;
  bottom: 0;
  left: 10%;
  top: 130%;
}

#inputElem {
  display: flex;
  line-height: 0.8;
}
#inputElem p {
  flex: 1;
  font-size: 15px;
  font-weight: 500;
  padding-right: 0.5rem;
  margin: auto;
}
#allowed {
  width: fit-content;
  margin: 0 auto;
}

.has-error {
  box-shadow: 0 0 5px rgb(255, 0, 0);
  border: 1px solid rgba(255, 0, 0, 1);
}
#btnGrp {
  height: 20px;
  width: 14rem;
  margin: auto;
  margin-bottom: 20px;
}

#error {
  font-weight: bolder;
  color: red;
}

#header p {
  vertical-align: top;
  line-height: 1;
  font-size: 15px;
}
#header i {
  color: chartreuse;
}

textarea {
  resize: none;
  margin: 0 auto;
}
textarea:focus {
  outline: none;
}

.spinner {
  margin: 100px auto;
  width: 40px;
  height: 40px;
  position: relative;
}

.cube1,
.cube2 {
  background-color: #333;
  width: 15px;
  height: 15px;
  position: absolute;
  top: 0;
  left: 0;

  -webkit-animation: sk-cubemove 1.8s infinite ease-in-out;
  animation: sk-cubemove 1.8s infinite ease-in-out;
}

.cube2 {
  -webkit-animation-delay: -0.9s;
  animation-delay: -0.9s;
}

@-webkit-keyframes sk-cubemove {
  25% {
    -webkit-transform: translateX(42px) rotate(-90deg) scale(0.5);
  }
  50% {
    -webkit-transform: translateX(42px) translateY(42px) rotate(-180deg);
  }
  75% {
    -webkit-transform: translateX(0px) translateY(42px) rotate(-270deg)
      scale(0.5);
  }
  100% {
    -webkit-transform: rotate(-360deg);
  }
}

@keyframes sk-cubemove {
  25% {
    transform: translateX(42px) rotate(-90deg) scale(0.5);
    -webkit-transform: translateX(42px) rotate(-90deg) scale(0.5);
  }
  50% {
    transform: translateX(42px) translateY(42px) rotate(-179deg);
    -webkit-transform: translateX(42px) translateY(42px) rotate(-179deg);
  }
  50.1% {
    transform: translateX(42px) translateY(42px) rotate(-180deg);
    -webkit-transform: translateX(42px) translateY(42px) rotate(-180deg);
  }
  75% {
    transform: translateX(0px) translateY(42px) rotate(-270deg) scale(0.5);
    -webkit-transform: translateX(0px) translateY(42px) rotate(-270deg)
      scale(0.5);
  }
  100% {
    transform: rotate(-360deg);
    -webkit-transform: rotate(-360deg);
  }
}

h4 {
  text-align: center;
}
p {
  text-align: center;
}

#header {
  margin: auto;
  border-bottom: 1px solid rgba(0, 0, 0, 0.125);
}
.input-group {
  width: fit-content;
  margin: 20px auto;
}
</style>
