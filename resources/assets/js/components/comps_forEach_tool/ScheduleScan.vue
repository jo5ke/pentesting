<template>
    <div id="buttonStartScan" >
        <h5>Schedule Scan</h5>
        <input type="text" name="daterangepicker_start" >
    </div>
</template>

<script>
    import daterangepicker from 'daterangepicker';
    import {SnotifyPosition, SnotifyStyle} from 'vue-snotify';
    import isLoggedIn from '../../mixins/checkIfLoggedIn';

   export default {
       mounted(){
           this.scheduleScan();
       },
       mixins:[isLoggedIn],
       methods:{
        scheduleScan(){
            let vm = this;
             $('input[name="daterangepicker_start"]').daterangepicker({
                singleDatePicker: true,
                timePicker: true,
                minDate: new Date(),
                locale:{
                    format:'DD/MM/YYYY h:mm A'
                }
            },
            //this func fires after user selects date
            function(start,end,label){
                
                //this code validates if all inputs are filled up..
                //this is needed for building the command for ajax.
                vm.validator.validateAll()
                    .then((isValid)=>{
                        if(isValid && vm.authorized)
                        {
                            let scheduled_date = start.format("YYYY-MM-DD HH:MM");
                                vm.$snotify.success(`Scheduled for ${scheduled_date}`,"Scheduled!",{
                                    position: SnotifyPosition.centerTop,
                                    backdrop:0.5
                                });


                            //gets the user id 
                            vm.checkIfLogged()
                                .then((response)=>{
                                    vm.user=response;

                                    //salju se datum za skeniranje, komanda, ime alatke 
                                    let scan_schedule_information = 
                                    {
                                        scan_date:scheduled_date,
                                        cmd:vm.parent.getCmd(),
                                        scan_name:vm.parent.route_to_scan_name(),
                                        user_id:vm.user.id
                                    }
                                    
                                    //DEBUG
                                    console.log(scan_schedule_information);

                                    axios.post("schedulescan",scan_schedule_information)
                                        .then((response)=>{
                                            console.log(response);
                                        })
                                        .catch((err)=>{
                                            console.log(err);
                                        })



                                })
                                .catch((err)=>{
                                    console.log(err);
                                });
                            
                          
                        }
                        else
                        {
                            vm.$snotify.error(`Fill all input fields`,"Invalid input",{
                                position: SnotifyPosition.centerTop,
                                backdrop:0.5
                            });
                        }
                    })
                    .catch((err)=>{
                        console.log(err);
                    })


            })
        }
       },
       props:
       {
           validator:{
               type:Object
           },
           authorized:{
               type:Boolean
           },
           parent:{
               type:Object
           }
       },
       data(){
           return { 
               isValidAll:false,
               user:null
           }
       }
   }
</script>

<style scoped>
#buttonStartScan {
    text-align: center;
    margin-top:20px;
    margin: 20px auto;
    width:fit-content;
}
#buttonStartScan > input {
    text-align: center;
}
</style>
