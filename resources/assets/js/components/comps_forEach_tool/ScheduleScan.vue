<template>
    <div id="buttonStartScan" >
        <h5>Schedule Scan</h5>
        <input type="text" name="daterangepicker_start" >
    </div>
</template>

<script>
import daterangepicker from "daterangepicker";
import { SnotifyPosition, SnotifyStyle } from "vue-snotify";
import canScan from '../../mixins/scansLeft';

export default {
  mixins:[canScan],
  mounted() {
    
      this.scansLeft().then(num_of_scans => {
        if(num_of_scans === 0)
        {
          this.$snotify.warning("0 Scans left!",{
              position: SnotifyPosition.centerTop,
              backdrop:0.5,
          });

          return;

        }
        else
          this.scheduleScan();
      });
  },
  beforeDestroy() {
    let dp = $(".daterangepicker");
    dp.remove();
  },
  methods: {
    scheduleScan() {
      let vm = this;
      $('input[name="daterangepicker_start"]').daterangepicker(
        {
          singleDatePicker: true,
          timePicker: true,
          minDate: new Date(),
          locale: {
            format: "DD/MM/YYYY h:mm A"
          }
        },
        //this func fires after user selects date
        function(start, end, label) {
          //this code validates if all inputs are filled up..
          //this is needed for building the command for ajax.
          

          vm.validator
            .validateAll()
            .then(isValid => {
              if (isValid && vm.authorized) {
                let scheduled_date = start.format("YYYY-MM-DD HH:mm");
                let date_for_show = start.format("DD/MM/YYYY HH:mm");
                vm.$snotify.success(
                  `Scheduled for ${date_for_show}`,
                  "Scheduled!",
                  {
                    position: SnotifyPosition.centerTop,
                    backdrop: 0.5
                  }
                );

                //salju se datum za skeniranje, komanda, ime alatke
                let scan_schedule_information = {
                  scan_date: scheduled_date,
                  cmd: vm.parent.getCmd(),
                  scan_name: vm.parent.route_to_scan_name()
                };


                axios
                  .post("schedulescan", scan_schedule_information)
                  .then(response => {
                    console.log(response);
                  })
                  .catch(err => {
                    console.log(err);
                  });

                $('input[name="daterangepicker_start"]')
                  .data("daterangepicker")
                  .remove();
              } else {
                vm.$snotify.error(`Fill all input fields`, "Invalid input", {
                  position: SnotifyPosition.centerTop,
                  backdrop: 0.5
                });
              }
            
            })
            .catch(err => {
              console.log(err);
            });
        }
      );
    }
  },
  props: {
    validator: {
      type: Object
    },
    authorized: {
      type: Boolean
    },
    parent: {
      type: Object
    }
  },
  data() {
    return {
      isValidAll: false,
      user: null
    };
  }
};
</script>

<style scoped>
#buttonStartScan {
  text-align: center;
  margin-top: 20px;
  margin: 20px auto;
  width: fit-content;
}
#buttonStartScan > input {
  text-align: center;
}
</style>
