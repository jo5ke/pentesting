<template>
    <form :class="{login_extend : !regForm,fform:true}">
        
        <tool-header v-if="!regForm">
          <p class="header_p">Login to your dashboard.</p>
        </tool-header>

        <tool-header v-if="regForm">
          <p>Create your Arcnet Security account.</p>
        </tool-header>


        <!-- <div v-if="regForm" class="fform_input">
          <label style="display:none;" :for="options.inputs.lastname.id">{{options.inputs.lastname.label}}</label>

          <b-form-input    
          autocomplete="on"

          :placeholder="options.inputs.lastname.label"
          :class="{'has-error':errLastName}"
          :type="options.inputs.lastname.type" 
          :id="options.inputs.lastname.id" 
          v-model="options.inputs.lastname.value" 
          :required="options.inputs.lastname.validation.required"
           v-validate="{
             rules:{
               required:true
            }}"
          :name="options.inputs.lastname.id"/>
          <span v-if="errors.has('lastname')" class="incorrect_input">
            Last name required!
          </span>
        
        </div> -->



        <div class="fform_input">
        
          <label style="display:none;" :for="options.inputs.email.id">{{options.inputs.email.label}}</label>


          <b-form-input  
          autocomplete="on"
          :placeholder="options.inputs.email.label"
          :class="{'has-error':errorEmail}"
          :type="options.inputs.email.type" 
          :id="options.inputs.email.id" 
          v-model="options.inputs.email.value" 
          :required="options.inputs.email.validation.required"
          v-validate="{required:true,email:true}"
          :name="options.inputs.email.id"
          />
        
        
          <span v-if="errors.has('email')" class="incorrect_input">
            Invalid email!
          </span>
        
        </div>

        <!-- firstname reg form -->
        <div v-if="regForm" class="fform_input">
          <label style="display:none;" :for="options.inputs.fullname.id">{{options.inputs.fullname.label}}</label>

          <b-form-input  
          autocomplete="on"

          :class="{'has-error':errName}"
          :type="options.inputs.fullname.type" 
          :id="options.inputs.fullname.id" 
          :placeholder="options.inputs.fullname.label"
          v-model="options.inputs.fullname.value" 
          :required="options.inputs.fullname.validation.required"
           v-validate="{
             rules:{
               required:true
            }}"
          :name="options.inputs.fullname.id"/>
          <span v-if="errors.has('firstname')" class="incorrect_input">
            Name required!
          </span>
        
        </div>
        <!-- PASSWORD INPUT  -->
        
        <div class="fform_input">
        
          <label style="display:none;" :for="options.inputs.pw.id">{{options.inputs.pw.label}}</label>

          <b-form-input  
          autocomplete="on"

          :placeholder="options.inputs.pw.label"
          :class="{'has-error':errorPw}"
          :type="options.inputs.pw.type" 
          :id="options.inputs.pw.id" 
          v-model="options.inputs.pw.value" 
          :required="options.inputs.pw.validation.required"
          v-validate="{
            rules:{
            required:true,
            regex:/^(?=.*[A-Za-z])(?=.*\d)(?=.*[$@$!%*#?&])[A-Za-z\d$@$!%*#?&]{8,}$/}}"
          :name="options.inputs.pw.id"/>

          <span v-if="errors.has('password')" class="incorrect_input">
            Min 8 characters, 1 letter, 1 number and 1 special character!
          </span>
       
        </div>

        <!-- SAME PW AGAIN  -->

        <div v-if="regForm" class="fform_input">
        
          <label style="display:none;" :for="options.inputs.pwagain.id">{{options.inputs.pwagain.label}}</label>

          <b-form-input   
          autocomplete="on"

          :placeholder="options.inputs.pwagain.label"
          :class="{'has-error':errorPwAgain}"
          :type="options.inputs.pwagain.type" 
          :id="options.inputs.pwagain.id" 
          v-model="options.inputs.pwagain.value" 
          :required="options.inputs.pwagain.validation.required"
           v-validate="{
             rules:{
             required:true,is:options.inputs.pw.value,
             regex:/^(?=.*[A-Za-z])(?=.*\d)(?=.*[$@$!%*#?&])[A-Za-z\d$@$!%*#?&]{8,}$/
            }}"
          :name="options.inputs.pwagain.id"/>
          <span v-if="errors.has('sameaspw')" class="incorrect_input">
            Not the same password!
          </span>
        
        </div>

        <vue-recaptcha 
        class="recaptcha_st"
        ref = "recaptcha"
        :sitekey = "sitekey"
        @verify = "markAsVerified"
        >
        </vue-recaptcha>

        <b-button v-if="regForm"  class="fixbtn btn btn-info btn-secondary actionbtn" @click="execRecaptcha()">
          Register!
        </b-button>



        <b-button v-if="!regForm" class="btn btn-info btn-secondary actionbtn" @click.once="submitHandler()">
          Log In!
        </b-button>

        
        
        <router-link to="forgotpw" id="forgotpw" v-if="!regForm">
         <p>Forgot password?</p>
        </router-link>

        <router-link v-if="!regForm" to="userreg" id="regHere">
          Sign up here!
        </router-link>

        

  </form>  
</template>

<script>
import { SnotifyPosition, SnotifyStyle } from "vue-snotify";
import ToolHeader from "../comps_forEach_tool/ToolHeader.vue";



export default {
  components: { ToolHeader },
  props: {
    options: {
      type: Object,
      twoWay: true
    },
    regForm: {
      type: Boolean
    },
    contactForm: {
      type: Boolean
    }
  },
  computed: {
    errName() {
      return this.errors.has("firstname");
    },
    errLastName() {
      return this.errors.has("lastname");
    },
    errorEmail() {
      return this.errors.has("email");
    },
    errorPw() {
      return this.errors.has("password");
    },
    errorPwAgain() {
      return this.errors.has("sameaspw");
    }
  },
  beforeDestroy() {
    let nav = document.getElementById("header_navbar");
    nav.style.display = "";
  },
  mounted() {
    let nav = document.getElementById("header_navbar");
    nav.style.display = "none";
  },
  data() {
    return {
      //REFACTOR WHEN RECAPTCHA ENABLED
      //REFACTORED!
      verified: false,

      captcha_response: undefined,
      widgetId: undefined,

      //TODO: CHANGE THIS SITE KEY WHEN DEPLOYED
      sitekey: "6LfsXlMUAAAAAOesOCJNVogbpNPRef3CsVY2lG2u"
    };
  },
  methods: {
    //METHODS FOR CAPTCHA
    markAsVerified(response) {
      this.captcha_response = response;

      //TODO: ruta nova za ovo.
      axios
        .post("/siteverify", {
          response: response
        })
        .then(resp => {
          if (resp.data.success) 
            this.verified = true;
          else {
            this.verified = false;
            this.$refs.recaptcha.reset();
          }
        });
    },
    submitHandler() {
      if (this.verified) {
        this.$validator.validateAll().then(result => {
          if (result) this.options.axiosSubmitForm();
        });
      }
    },

    execRecaptcha() {
      if (this.verified) {
        this.$validator.validateAll().then(result => {
          if (result) this.options.axiosSubmitForm();
        });
      } else {
        this.$snotify.warning(`Complete Recaptcha`, `Recaptcha!`, {
          position: SnotifyPosition.centerTop,
          backdrop: 0.5,
          timeout: 5000
        });
      }
    }
  }
};
</script>


<style scoped>
.login_extend {
  padding-bottom: 1.5em !important;
}

#regHere {
  color: rgb(6, 4, 88);
  float: right;
  margin-right: 2%;
}
#regHere:hover {
  text-decoration: none;
  font-weight: bold;
  color: rgb(6, 4, 88);
  float: right;
  margin-right: 2%;
}

#forgotpw {
  color: rgb(6, 4, 88);
  float: left;
  margin-left: 2%;
}

#forgotpw:hover {
  text-decoration: none;
  font-weight: bold;
  color: rgb(6, 4, 88);
  float: left;
  margin-left: 2%;
}

.recaptcha_st {
  padding: 2%;
  margin: 0 auto;
  width: 89%;
}

.g-recaptcha {
  width: 100%;
  height: 100%;
}

.router-link-exact-active button {
  font-weight: bold;
  color: rgb(21, 56, 122);
}

.btn {
  border-radius: 0%;
  margin-top: 7%;
  margin-bottom: 2%;
}
.fixbtn {
  margin-top: 20px;
}

.has-error {
  border: 1px solid rgba(255, 0, 0, 1);
}

.incorrect_input {
  float: left;
  width: 100%;
  color: red;
  font-size: 10px;
  font-weight: 700;
}

</style>
